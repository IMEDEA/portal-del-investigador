<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Instalación</title>
        <link rel="stylesheet" href="/investigacion/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/investigacion/">A Pelican Blog </a></h1>
                <nav><ul>
                    <li><a href="/investigacion/pages/contacto.html">Contacto</a></li>
                    <li><a href="/investigacion/pages/como-contribuir.html">Cómo Contribuir</a></li>
                    <li><a href="/investigacion/core.html">CORE: Módulo de Gestión Centralizada</a></li>
                    <li><a href="/investigacion/cvn.html">CVN: Módulo de Gestión del Currículum Vitae Normalizado</a></li>
                    <li><a href="/investigacion/">Portal del Investigador</a></li>
                    <li class="active"><a href="/investigacion/pages/instalacion.html">Instalación</a></li>
                    <li><a href="/investigacion/team.html">Equipo de Desarrollo</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
    <h1 class="entry-title">Instalación</h1>
    
    <p>
    La presente guía de instalación proporciona el paso a paso de la instalación y configuración del proyecto bajo un entorno con sistema operativo GNU/Linux, concretamente Ubuntu.
</p>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">1. Clonar el repositorio con sus submódulos</li>
    </ul>
    <div class="content">
        <pre>git clone --recursive https://github.com/tic-ull/investigacion.git</pre>
    </div>
</div>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">2. Instalar dependencias</li>
    </ul>
    <div class="content">
        <p>
            Para la instalación de dependencias de módulos Python se emplea <i>pip</i>. 
            Se recomienda el uso de <i>virtualenv</i> junto con esta herramienta,
            en las instrucciones no se entrará a explicar su funcionamiento.
        </p>
<pre>
sudo apt-get install python-pip
sudo pip install -U distribute
sudo apt-get install postgresql postgresql-client postgresql-contrib libpq-dev \
                     libxml2-dev libxslt1-dev python-dev xvfb redis-server mercurial
sudo pip install -r requirements.min.txt
</pre>
    </div>
</div>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">3. Configurar el proyecto y sus módulos</li>
    </ul>
    <div class="content">
        <p>
            Los parámetros de configuración del proyecto y sus módulos se establecen en los ficheros <i>settings.py</i>. 
            Varios de estos parámetros necesitan ser sobreescritos, para ello se emplean los ficheros <i>settings_local.py</i>.
            Se proporcionan los ficheros <i>settings_local-sample.py</i> como ejemplo y punto de partida, 
            por lo que se recomienda su uso.
        </p>

        <h4>Configuración del Proyecto Investigación</h4>
        <div class="alert alert-info">
            <b>investigacion/settings_local.py</b>
        </div>
        <pre>cp investigacion/settings_local-sample.py investigacion/settings_local.py</pre>
        <table class="table table-striped table-condensed">
            <tr>
                <th>VARIABLE</th>
                <th>DESCRIPCIÓN</th>
                <th>TIPO</th>
            </tr>
            <tr>
                <td>BASE_URL</td>
                <td><i>URL</i> de la página principal del proyecto. Por defecto es un servicio externo</td>
                <td>string</td>
            </tr>
            <tr>
                <td>SECRET_KEY</td>
                <td colspan="2">
                    <a href="https://docs.djangoproject.com/en/1.7/ref/settings/#secret-key" target="_blank">https://docs.djangoproject.com/en/1.7/ref/settings/#secret-key</a>
                </td>
            </tr>
            <tr>
                <td>DEBUG</td>
                <td colspan="2">
                    <a href="https://docs.djangoproject.com/en/1.7/ref/settings/#std:setting-DEBUG" target="_blank">https://docs.djangoproject.com/en/1.7/ref/settings/#std:setting-DEBUG</a>
                </td>
            </tr>   
            <tr>
                <td>TEMPLATE_DEBUG</td>
                <td colspan="2">
                    <a href="https://docs.djangoproject.com/en/1.7/ref/settings/#template-debug" target="_blank">https://docs.djangoproject.com/en/1.7/ref/settings/#template-debug</a>
                </td>
            </tr>
            <tr>
                <td>DEVEL</td>
                <td>Si DEVEL es True (Entorno de Desarrollo), el servidor de aplicaciones de Django servirá los ficheros estáticos. En otro caso, deberá hacerse desde el Servidor Web del sistema</td>
                <td>boolean</td>
            </tr>
            <tr>
                <td>ADMINS</td>
                <td colspan="2">
                    <a href="https://docs.djangoproject.com/en/1.7/ref/settings/#std:setting-ADMINS" target="_blank">https://docs.djangoproject.com/en/1.7/ref/settings/#std:setting-ADMINS</a>
                </td>
            </tr>
            <tr>
                <td>SUPPORT</td>
                <td>Nombre del Departamento de Soporte que se le mostrará al usuario en caso de error</td>
                <td>string</td>
            </tr>
            <tr>
                <td>EMAIL_SUPPORT</td>
                <td>Correo Electrónico del Departamento de Soporte que se le mostrará al usuario en caso de error</td>
                <td>string</td>
            </tr>
            <tr>
                <td>CAS_SERVER_URL</td>
                <td>URL del <a href="autenticacion.html">Servicio de Autenticación</a> (CAS)</td>
                <td>string</td>
            </tr>
            <tr>
                <td>WS_SERVER_URL</td>
                <td><i>URL</i> base del Servicio de <a href="web-services.html">Web Services</a></td>
                <td>string</td>
            </tr>           
        </table>
        <h4>Configuración específica de cada módulo</h4>
        <ul>
            <li><a href="cvn.html#configuracion">Configuración del módulo CVN</a></li>
        </ul>
    </div>

</div>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">4. Configurar bases de datos</li>
    </ul>
    <div class="content">
        <div class="alert alert-warning">
            Se recomienda el uso de PostgreSQL como Sistema Gestor de Bases de Datos. 
            No se entrará a detallar la configuración del SGBD ni el proceso de creación de usuarios o bases de datos.
        </div>
        <h4>Base de Datos por defecto</h4>
        <p>
            La base de datos puede configurarse sobreescribiendo los valores por defecto en <i>investigacion/settings_local.py</i> siguiendo el formato que se indica en la <a href="https://docs.djangoproject.com/en/dev/ref/settings/#databases" target="_blank">documentación de Django</a>. 
            Una vez configurada, se deben ejecutar los siguientes comandos:
        </p>
<pre>
sudo python manage.py makemigrations
python manage.py migrate
</pre>
        <h4 id="bbddh">Base de Datos histórica</h4>
        <p>
            Para la realización de Informes de Producción Científica extraídos de los CVN se puede clonar la base de datos por defecto a una base de datos histórica de sólo lectura. 
            Cada base de datos histórica se debe añadir a la configuración de bases de datos de Django en <i>investigacion/settings_local.py</i>, 
            y posteriormente al diccionario <i>HISTORICAL</i> cumpliendo con el siguiente formato:
        </p>
<pre>
HISTORICAL = {
    '2013': 'nombre_bbdd_historica_2013',
    '2014': 'nombre_bbdd_historica_2014',
    ...
}
</pre>
    </div>
</div>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">5. Sistema de Autenticación</li>
    </ul>
    <div class="content">
        <p>
            El Sistema de Autentificación implementado actualmente es CAS, 
            con un <i>backend</i> basado en <a href="https://bitbucket.org/cpcc/django-cas/overview" target="_blank"><i>django-cas</i></a>.
        </p>
        <p>
            CAS es un sistema de <i>Single Sign-On (SSO)</i>, por lo que el proyecto no incluye formulario de inicio de sesión o registro de usuarios. 
            Cuando un nuevo usuario accede con sus credenciales a través del SSO se crea automáticamente como usuario del proyecto.
        </p>
        <p>
            Es posible cambiar el sistema de autenticación actual de manera sencilla, este deberá manejar externamente el registro y el inicio de sesión.
            Para ello, necesitará crear un nuevo <i>backend</i> de autenticación o adaptar uno ya existente sobreescribiendo su función <code>authenticate</code>, 
            asegurándose de que se cumplen las siguientes condiciones:
        </p>

        <ul>
            <li>
                <p>
                    Si las credenciales de un usuario son válidas se debe realizar una llamada a <code>UserProfile.get_or_create_user</code>, 
                    con el <i>username</i> y el documento (NIF/NIE, Pasaporte, etc.) como parámetros.
                </p>
            </li>
            <li>
                <p>
                    Debe introducir en <code>request.session['attributes']</code> un <i>json</i> 
                    con información del usuario siguiendo la siguiente estructura:
                </p>
<pre>
{
    'TipoCuenta': 'personal',
    'username': 'Usuario',
    'first_name': 'Nombre',
    'last_name': 'Apellidos',
    'NumDocumento': 'NIF',
    'email': 'email@example.com',
}
</pre>

        <table class="table table-striped table-condensed">
            <tr>
                <th>CLAVE</th>
                <th>DESCRIPCIÓN</th>
                <th>USO FUERA DEL BACKEND POR DEFECTO</th>
            </tr>
            <tr>
                <td>TipoCuenta</td>
                <td>
                    <p>Tipo de cuenta de usuario</p>
                    <p>Se bloqueará el acceso a los usuarios con el tipo de cuenta que se establezcan en la lista <i>settings.CAS_TIPO_CUENTA_NOAUT</i></p>
                </td>
                <td>No</td>
            </tr>
            <tr>
                <td>username</td>
                <td>Nombre de usuario para el inicio de sesión</td>
                <td>Sí</td>
            </tr>
            <tr>
                <td>first_name</td>
                <td>Nombre del usuario</td>
                <td>Sí</td>
            </tr>
            <tr>
                <td>last_name</td>
                <td>Apellidos del usuario</td>
                <td>Sí</td>
            </tr>
            <tr>
                <td>NumDocumento</td>
                <td>Número de Documento de Identidar del usuario.</td>
                <td>No</td>
            </tr>
            <tr>
                <td>email</td>
                <td>Correo electrónico del usuario</td>
                <td>Sí</td>
            </tr>
        </table>
            </li>
        </ul>

        <div class="alert alert-warning">
            <p>
                Para el uso del sistema de inicio de sesión integrado en el proyecto se requieren mayores cambios que los indicados en esta guía.
                Aunque no se detallan, debe tener en cuenta que independientemente del método de autentificación, la creación de usuarios debe 
                realizarse siempre a través de <code>UserProfile.get_or_create_user</code>.
            </p>
        </div>

        <br>
        <h4>Ejemplo de Sistema de Autenticación basado en Django CAS</h4>

        <p>
            Si dispone de un servidor CAS puede integrarlo en el proyecto realizando los siguientes pasos:
        </p>
        <ol>
            <li>
                <p>
                    Configurar el servidor CAS para que retorne los atributos indicados en esta Sección.
                </p>
                <p>
                    Dependiendo del <i>backend</i> de autenticación elegido y la versión de CAS, 
                    puede ser necesario retornar algún otro atributo, como el <code>uid</code> 
                    con el username del usuario.
                </p>
            </li>
            <li>
                <p>Instalar el <i>backend</i> de autenticación, por ejemplo, <a href="https://bitbucket.org/cpcc/django-cas/overview">django-cas</a>.</p>
            </li>
            <li>
                <p>Sobreescribir los parámetros de configuración del <i>settings</i> que se encuentran en la Sección <i>AUTHENTICATION CAS - ULL</i>, se recomienda hacer uso del <i>settings_local.py</i>.</p>
            </li>
            <li>
                <p>En el fichero <i>core/backends.py</i> se encuentra un <i>backend</i> de autenticación que emplea el <i>django-cas</i> instalado, con la función <code>authenticate</code> sobreescrita con las necesidades del Portal del Investigador. Por lo que no es necesario modificar el resto de la configuración para su uso.</p>
            </li>
        </ol>

        <br>
        <h4>Ejemplo de Sistema de Autenticación basado en ModelBackend</h4>

        <p>Una manera sencilla de autenticarse en la aplicación es hacer uso del Sistema de Autenticación por defecto de Django. Para ello, se deben realizar los siguientes pasos:</p>
        <ol>
            <li>
                <p>Sobreescribir la variable <i>settings.AUTHENTICATION_BACKENDS</i> sustituyendo el <i>backend</i> <code>core.backends.CASBackend</code> por <code>django.contrib.auth.backends.ModelBackend</code>.</p>
            </li>
            <li>
                <p>Reemplazar las urls a las vistas de login de <i>django_cas</i> de <i>investigacion/urls.py</i> por las siguientes:</p>
<pre>
urlpatterns += patterns('',
    url(r'^accounts/login/$', 'django.contrib.auth.views.login',
       {'template_name': 'admin/login.html'}, name="login"),
    url(r'^accounts/logout/$', 'django.contrib.auth.views.logout', name="logout"),
)
</pre>
            </li>
            <li>
                <p>La creación de usuarios puede realizarse desde una <i>shell</i> Django, realizando una llamada a <code>UserProfile.get_or_create_user</code>.</p>
                <p>Una vez creado el usuario debe asignarle una contraseña a través de <code>User.set_password</code>.</p>
            </li>
        </ol>
        <p>
            Cuando una página requiera autenticación, el usuario será redirigido al formulario de login de Django.
        </p>
    </div>

</div>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">6. Creación de Servicios Web</li>
    </ul>
    <div class="content">
        <p>
            Parte de la funcionalidad del Portal del Investigador requiere la existencia de <i>Servicios Web</i> que provean información necesaria.
            Estas funcionalidades no son esenciales, por lo que pueden ser deshabilitadas.
        </p>
        <p>
            La información necesaria para la creación de los diferentes <i>Servicios Web</i> 
            se puede encontrar en las secciones correspondientes de cada módulo:
        </p>
        <ul>
            <li><a href="core.html#webservices">CORE</a></li>
            <li><a href="cvn.html#webservices">CVN</a></li>
        </ul>
    </div>
</div>

<div class="section">
    <ul class="nav nav-tabs header">
        <li class="active">7. Acceso al Portal</li>
    </ul>
    <div class="content">
        <p>
            La estructura de URLs está diseñada siguiendo el esquema <i>dominio_institución/url_investigación/aplicación/</i>, por lo que una URL válida sería, por ejemplo, https://www.example.com/investigacion/cvn/.
        </p>
        <div class="alert alert-warning">
            <p>
                Puede cambiar esta estructura en el fichero <i>investigacion/urls.py</i>, pero debe tener en cuenta que por defecto todas las URLs siguen este esquema.
            </p>
        </div>
        <p>
            A modo de ejemplo, si se quiere acceder al módulo de Gestión del CVN del Portal desde el servidor de desarrollo de Django, 
            suponiendo que se haya ejecutado con el comando: <code>python manage.py runserver</code>, se deberá acceder a 
            http://localhost:8000/investigacion/cvn/.
        </p>
        <p>
            Por defecto, la URL principal del proyecto, http://localhost:8000/investigacion/ es parametrizable, 
            con el objetivo de localizar un sitio web de la institución externo a Django.
        </p>
    </div>
</div>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>